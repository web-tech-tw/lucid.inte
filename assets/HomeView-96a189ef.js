import{_ as w,o as l,c as u,w as c,v as m,a as o,t as h,b as f,p as g,d as k}from"./index-01fd1cfc.js";const p={name:"HomeView",data:()=>({isPowerPressed:!1,isDownloadCompleted:!1,isTouchDevice:!1,progressTicks:-1,emulator:null,emulatorExtendedInfo:{isPaused:!1,mouseEnabled:!1},restoreFile:null,virtualKeyboardBlackHole:" ",systemProfile:{slitaz:{memory_size:64*1024*1024,vga_memory_size:8*1024*1024,cdrom:{url:"./machine/slitaz.iso",size:36419584}},xpud:{memory_size:512*1024*1024,vga_memory_size:32*1024*1024,cdrom:{url:"./machine/xpud.iso",size:66529280}}}}),watch:{isDownloadCompleted(e){!e||!this.isPowerPressed||setTimeout(()=>{this.machinePowerBoot(this.emulator)},500)},virtualKeyboardBlackHole(e){if(e!==" "){if(e==="")this.machineSendKeyboardCode(this.emulator,14);else{const t=e.substring(1);this.machineSendKeyboardText(this.emulator,t)}window.requestAnimationFrame(()=>{this.virtualKeyboardBlackHole=" "})}}},computed:{isEmulatorRunning(){return this.emulatorExtendedInfo.isPaused?!0:this.emulator&&this.emulator.is_running()},isInFullScreen(){return!!document.fullscreenElement},isShowProgressCircle(){return!this.isPowerPressed||this.progressTicks>=0},isShowInitPowerButton(){return!this.isDownloadCompleted&&!this.isPowerPressed||this.isDownloadCompleted&&!this.isEmulatorRunning},progressPercentage(){return(this.progressTicks<1?this.progressTicks:1)*100},progressPercentageString(){return`${this.progressPercentage.toFixed(0)}%`},progressCircleSvgValue(){const e=60*Math.PI;return{strokeDasharray:e,strokeDashoffset:e-this.progressPercentage/100*e}},powerPauseText(){return this.emulatorExtendedInfo.isPaused?"Resume":"Pause"},powerResetText(){return"Reset"},powerPowerText(){return this.isEmulatorRunning?"Power OFF":"Power ON"},emulatorScreenInfo(){return this.emulator.v86.cpu.devices.vga.stats},emulatorEventMethods(){return[{name:"download-progress",method:e=>{if(this.progressTicks=0,e.file_name.endsWith(".wasm")){const t=e.file_name.split("/"),i=t[t.length-1];this.lucidLog(`Fetching "${i}" ...`);return}if(e.file_index===e.file_count-1&&e.loaded>=e.total-2048){this.isDownloadCompleted=!0,this.lucidLog("Download completed!"),this.isPowerPressed||this.lucidLog("Click power button to start."),this.progressTicks=-1;return}typeof e.file_index=="number"&&e.file_count&&this.lucidLog(`Downloading images (${e.file_index+1}/${e.file_count}) ...`),e.total&&typeof e.loaded=="number"?this.progressTicks=e.loaded/e.total:this.lucidLog(`Progress: ${this.progressTicks++%50}`)}},{name:"download-error",method:e=>{this.progressTicks=0,this.progressState=`
              Error: Loading "${e.file_name}" failed.
              Check your connection and reload the page to try again later.
            `}},{name:"mouse-enable",method:e=>{this.emulatorExtendedInfo.mouseEnabled=e}},{name:"screen-set-mode",method:()=>{this.documentHandleResizeScreen()}},{name:"screen-set-size-graphical",method:()=>{this.documentHandleResizeScreen()}},{name:"emulator-stopped",method:()=>{this.isInFullScreen&&this.documentRequestExitFullScreen()}}]}},methods:{lucidLog(e){console.log(`[Lucid] ${e}`)},machineSetup(e){const t={...e};t.wasm_path="./v86.wasm",t.bios={url:"./machine/bios/seabios.bin"},t.vga_bios={url:"./machine/bios/vgabios.bin"},t.network_relay_url=t.network_relay_url||"wss://relay.widgetry.org/",t.screen_container=this.$refs.screenContainer;const i=window.V86Starter;return this.emulator=new i(t),this.emulator},machineSetupEventListener(e){for(const t of this.emulatorEventMethods)e.add_listener(t.name,t.method)},machineScreenSetScale(e,t){e.screen_set_scale(t)},async machineStateSave(e){const t=await e.save_state(),i=new Blob([t]),n=document.createElement("a");n.download="lucid-state.bin",n.href=window.URL.createObjectURL(i),n.dataset.downloadurl=`application/octet-stream:${n.download}:${n.href}`,n.click()},machineStateRestore(e,t){e.stop();const i=new FileReader;i.onload=n=>{e.restore_state(n.target.result),e.run()},i.readAsArrayBuffer(t)},machinePowerBoot(e){this.isPowerPressed=!0,this.isDownloadCompleted&&(this.isEmulatorRunning?(e.stop(),e.restart()):e.run())},machineSendKeyboardText(e,t){e.keyboard_send_text(t)},machineSendKeyboardCode(e,t){e.bus.send("keyboard-code",t)},machinePowerPause(e){this.emulatorExtendedInfo.isPaused?(e.run(),this.emulatorExtendedInfo.isPaused=!1):(e.stop(),this.emulatorExtendedInfo.isPaused=!0)},machinePowerReset(e){e.restart()},documentLockMouse(){const e=document.body,t=e.requestPointerLock||e.mozRequestPointerLock||e.webkitRequestPointerLock||e.msRequestPointerLock;t?t.call(e):console.warn("The browser is not support requestPointerLock")},documentRequestFullScreen(){const e=this.$refs.screenContainer,t=e.requestFullscreen||e.mozRequestFullScreen||e.webkitRequestFullscreen||e.msRequestFullscreen;t?t.call(e):console.warn("The browser is not support requestFullscreen")},documentRequestExitFullScreen(){const e=document.exitFullscreen||document.mozCancelFullScreen||document.webkitExitFullscreen||document.msExitFullscreen;e?e.call(document):console.warn("The browser is not support exitFullscreen")},documentHandleResizeScreen(){if(!this.isEmulatorRunning)return;this.emulatorScreenInfo.is_graphical||this.machineScreenSetScale(this.emulator,1);const e={width:this.$refs.screenContainer.clientWidth||1,height:this.$refs.screenContainer.clientHeight||1},t={width:this.emulatorScreenInfo.res_x||1,height:this.emulatorScreenInfo.res_y||1};if(e.height>e.width){const i=e.width/t.width,n=e.height/t.height,a=Math.min(i,n);this.machineScreenSetScale(this.emulator,a)}else this.machineScreenSetScale(this.emulator,1)},documentHandleChangeRestoreFile(e){this.restoreFile=e.target.files[0]},documentHandleClickBox(){this.emulatorExtendedInfo.mouseEnabled&&this.documentLockMouse()},documentHandleClickButtonInitPower(){this.isPowerPressed||this.machinePowerBoot(this.emulator)},documentHandleClickButtonPower(){this.machinePowerBoot(this.emulator)},documentHandleClickButtonPause(){this.machinePowerPause(this.emulator)},documentHandleClickButtonReset(){this.machinePowerReset(this.emulator)},documentHandleClickButtonFullScreen(){this.documentRequestFullScreen()},documentHandleClickButtonCallSmartphoneVirtualKeyboard(){this.$refs.virtualKeyboardCaller.focus()}},created(){this.isTouchDevice="ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0,window.addEventListener("resize",this.documentHandleResizeScreen)},destroyed(){window.removeEventListener("resize",this.documentHandleResizeScreen)},mounted(){this.documentHandleResizeScreen();const e=new URLSearchParams(window.location.search),t=(()=>{const n=e.get("profile"),a=this.systemProfile.slitaz;return n?this.systemProfile[n]||a:navigator.language==="zh-TW"&&this.systemProfile.xpud||a})();e.get("network_relay_url")&&(t.network_relay_url=e.get("network_relay_url"));const i=this.machineSetup(t);this.machineSetupEventListener(i)}},d=e=>(g("data-v-b4d32e27"),e=e(),k(),e),b={class:"w-20 h-20"},x=d(()=>o("circle",{class:"text-gray-300","stroke-width":"5",stroke:"currentColor",fill:"transparent",r:"30",cx:"40",cy:"40"},null,-1)),P=["stroke-dasharray","stroke-dashoffset"],v={key:0,xmlns:"http://www.w3.org/2000/svg",class:"h-6 w-6 absolute text-xl text-emerald-700",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor","stroke-width":"2"},S=d(()=>o("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M13 10V3L4 14h7v7l9-11h-7z"},null,-1)),y=[S],_={key:1,class:"absolute text-xl text-blue-700"},C={ref:"screenContainer"},B=d(()=>o("div",{id:"screen"},null,-1)),H=d(()=>o("canvas",{id:"vga",class:"mx-auto"},null,-1)),R={id:"virtual-keyboard-caller-box"},E={class:"mt-5 px-3 w-full flex justify-between"};function F(e,t,i,n,a,s){return l(),u("div",null,[c(o("div",{onClick:t[0]||(t[0]=(...r)=>s.documentHandleClickButtonInitPower&&s.documentHandleClickButtonInitPower(...r)),class:"fixed inline-flex items-center justify-center overflow-hidden rounded-full top-0 right-12 md:right-1/2 2xl:right-2 bg-white hover:cursor-pointer"},[(l(),u("svg",b,[x,o("circle",{class:"text-blue-600","stroke-width":"5","stroke-linecap":"round",stroke:"currentColor",fill:"transparent",r:"30",cx:"40",cy:"40","stroke-dasharray":s.progressCircleSvgValue.strokeDasharray,"stroke-dashoffset":s.progressCircleSvgValue.strokeDashoffset},null,8,P)])),s.isShowInitPowerButton?(l(),u("svg",v,y)):(l(),u("span",_,h(s.progressPercentageString),1))],512),[[m,s.isShowProgressCircle]]),o("div",{class:"bg-black h-96 overflow-hidden",onClick:t[2]||(t[2]=(...r)=>s.documentHandleClickBox&&s.documentHandleClickBox(...r))},[o("div",C,[B,H,o("div",R,[c(o("textarea",{id:"virtual-keyboard-caller",ref:"virtualKeyboardCaller","onUpdate:modelValue":t[1]||(t[1]=r=>e.virtualKeyboardBlackHole=r),autocorrect:"off",autocapitalize:"none",spellcheck:"false",tabindex:"0"},null,512),[[f,e.virtualKeyboardBlackHole]])])],512)]),c(o("div",E,[o("button",{class:"w-16 text-base font-medium text-gray-600 hover:text-gray-500",onClick:t[3]||(t[3]=(...r)=>s.documentHandleClickButtonPower&&s.documentHandleClickButtonPower(...r))}," 電源 "),o("button",{class:"w-16 text-base font-medium text-gray-600 hover:text-gray-500",onClick:t[4]||(t[4]=(...r)=>s.documentHandleClickButtonPause&&s.documentHandleClickButtonPause(...r))},h(e.emulatorExtendedInfo.isPaused?"恢復":"暫停"),1),o("button",{class:"w-16 text-base font-medium text-gray-600 hover:text-gray-500",onClick:t[5]||(t[5]=(...r)=>s.documentHandleClickButtonReset&&s.documentHandleClickButtonReset(...r))}," 重置 "),c(o("button",{class:"w-28 text-base font-medium text-gray-600 hover:text-gray-500",onClick:t[6]||(t[6]=(...r)=>s.documentHandleClickButtonCallSmartphoneVirtualKeyboard&&s.documentHandleClickButtonCallSmartphoneVirtualKeyboard(...r))}," 呼出虛擬鍵盤 ",512),[[m,e.isTouchDevice]]),o("button",{class:"w-28 text-base font-medium text-gray-600 hover:text-gray-500",onClick:t[7]||(t[7]=(...r)=>s.documentHandleClickButtonFullScreen&&s.documentHandleClickButtonFullScreen(...r))}," 進入全螢幕 ")],512),[[m,!s.isShowInitPowerButton]])])}const T=w(p,[["render",F],["__scopeId","data-v-b4d32e27"]]);export{T as default};
